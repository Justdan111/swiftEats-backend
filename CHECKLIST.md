# SwiftEats Backend - Complete Build Checklist

**Current Status:** Phase 2 - Architecture & Core Modules  
**Date:** December 24, 2025

---

## ğŸ“Š What You've Built So Far âœ…

### Phase 1: Foundation (COMPLETE)
- âœ… PostgreSQL database with Docker
- âœ… pgAdmin for database management
- âœ… 6 migration files (users, restaurants/menu, orders/payments/cart)
- âœ… Database schema with proper FK relationships, indexes, constraints
- âœ… Users table with authentication support
- âœ… Go project structure initialized
- âœ… Dependencies: gorilla/mux, JWT, bcrypt, pgx, sqlc
- âœ… User authentication (register/login with JWT)
- âœ… Auth middleware for protected routes
- âœ… SQLC installed and configured
- âœ… SQLC generated all typed Go models and query functions

### Current Architecture

```
cmd/server/main.go
  â”œâ”€â”€ HTTP Router (gorilla/mux)
  â”œâ”€â”€ Database Connection (*sql.DB)
  â””â”€â”€ Routes
      â”œâ”€â”€ POST /api/register (User service)
      â”œâ”€â”€ POST /api/login (User service)
      â”œâ”€â”€ GET /api/me (User service - protected)
      â””â”€â”€ GET /health

internal/
  â”œâ”€â”€ user/ (COMPLETE)
  â”‚   â”œâ”€â”€ handler.go (HTTP layer)
  â”‚   â”œâ”€â”€ service.go (business logic)
  â”‚   â”œâ”€â”€ repository.go (data access)
  â”‚   â”œâ”€â”€ model.go (User struct)
  â”‚   â””â”€â”€ routes.go (route registration)
  â”‚
  â”œâ”€â”€ db/ (GENERATED BY SQLC)
  â”‚   â”œâ”€â”€ models.go (Restaurant, MenuItem, Order, OrderItem, Cart, Payment)
  â”‚   â”œâ”€â”€ queries.sql.go (all SQLC query functions)
  â”‚   â””â”€â”€ db.go (Queries interface)
  â”‚
  â”œâ”€â”€ middleware/
  â”‚   â””â”€â”€ auth.go (JWT verification)
  â”‚
  â”œâ”€â”€ utils/
  â”‚   â””â”€â”€ response.go (JSON response helpers)
  â”‚
  â””â”€â”€ store/ (pgxpool-based connection pool)
```

---

## ğŸ› ï¸ What You Need to Build Next

### PHASE 2A: Add Missing SQLC Queries (CRITICAL)

**Why:** You only have ~10 queries but need 20+ for full functionality

**What to do:**

1. Add to `internal/db/queries/queries.sql`:
   ```sql
   -- Missing Restaurant queries
   -- name: GetAllRestaurants :many
   -- name: GetRestaurantByID :one
   -- name: GetMenuItemsByRestaurantID :many
   
   -- Missing Cart queries
   -- name: GetOrCreateCart :one
   -- name: AddToCart :one
   -- name: RemoveFromCart :exec
   -- name: GetCartItems :many
   -- name: ClearCart :exec
   
   -- Missing Order queries
   -- name: GetUserOrders :many
   -- name: GetOrderItems :many
   
   -- Missing Payment queries
   -- name: GetPaymentByOrderID :one
   -- name: UpdatePaymentStatus :exec
   ```

2. Run `sqlc generate` again

3. Verify new functions appear in `queries.sql.go`

**Files to create/modify:**
- `internal/db/queries/queries.sql` â†’ Add missing queries

**Effort:** 30 minutes

---

### PHASE 2B: Refactor DB Connection Layer (IMPORTANT)

**Why:** Currently using `*sql.DB` (old Go driver). SQLC works better with pgx context.

**Current Issue:** 
- `cmd/server/main.go` uses `sql.Open("postgres", ...)`
- `internal/store/db.go` has pgxpool but isn't used
- User module hardcodes raw SQL instead of using SQLC

**What to do:**

1. Update `cmd/server/main.go`:
   - Replace `sql.Open()` with `pgxpool.New()`
   - Initialize SQLC `Queries` from the pool
   - Pass queries to handlers/services

2. Update `internal/user/repository.go`:
   - Stop using raw SQL
   - Use SQLC generated queries instead
   - Change signature to accept `*db.Queries`

3. Create a database initialization helper in `internal/store/db.go`

**Files to modify:**
- `cmd/server/main.go` â†’ Switch to pgxpool + SQLC
- `internal/user/repository.go` â†’ Use SQLC queries
- `internal/user/service.go` â†’ Update for SQLC
- `internal/store/db.go` â†’ Add initialization logic

**Effort:** 45 minutes

---

### PHASE 3: Build Restaurant Module

**Routes needed:**
```
GET  /api/restaurants          â†’ List all restaurants
GET  /api/restaurants/{id}     â†’ Get one restaurant
GET  /api/restaurants/{id}/menu â†’ Get menu items for restaurant
```

**Create:**
- `internal/restaurant/model.go` â†’ Restaurant, MenuItem types
- `internal/restaurant/repository.go` â†’ Uses SQLC queries
- `internal/restaurant/service.go` â†’ Business logic
- `internal/restaurant/handler.go` â†’ HTTP handlers
- `internal/restaurant/routes.go` â†’ Register routes in main

**Pattern (copy from user module):**
```
Handler (HTTP) 
  â†’ calls Service
    â†’ calls Repository
      â†’ executes SQLC queries
        â†’ returns Database models
```

**Tests:**
```bash
curl http://localhost:8080/api/restaurants
curl http://localhost:8080/api/restaurants/{id}
curl http://localhost:8080/api/restaurants/{id}/menu
```

**Effort:** 1 hour

---

### PHASE 4: Build Cart Module

**Routes needed:**
```
POST   /api/cart/items            â†’ Add item to cart
GET    /api/cart                  â†’ View cart items
DELETE /api/cart/items/{item_id}  â†’ Remove from cart
POST   /api/cart/checkout         â†’ Clear cart (for order)
```

**Create:**
- `internal/cart/model.go`
- `internal/cart/repository.go`
- `internal/cart/service.go`
- `internal/cart/handler.go`
- `internal/cart/routes.go`

**Special Logic:**
- One cart per user (unique index in DB)
- Auto-create cart if doesn't exist
- Validate menu items exist before adding
- Calculate totals

**Effort:** 1.5 hours

---

### PHASE 5: Build Order Module (CORE - MOST COMPLEX)

**Routes needed:**
```
POST   /api/orders              â†’ Create order with items
GET    /api/orders              â†’ List user's orders
GET    /api/orders/{id}         â†’ Get order + items details
GET    /api/orders/{id}/items   â†’ Get items in order
```

**Create:**
- `internal/order/model.go`
- `internal/order/repository.go`
- `internal/order/service.go` (handles transactions!)
- `internal/order/handler.go`
- `internal/order/routes.go`

**Critical Logic (Service Layer):**
```
1. Validate: user exists, restaurant exists, items exist
2. Calculate: sum prices, verify totals
3. Idempotency: check idempotency_key (prevent duplicate orders)
4. Transaction: if ANY insert fails, rollback ALL
   - Insert order
   - Insert order_items (loop)
   - Update restaurant stats (later)
5. Return: order_id + created order details
```

**Why Transactions Matter:**
- If order inserts but items fail â†’ broken order in DB
- If items insert but order fails â†’ orphaned order_items
- Database enforces consistency via FK + transaction rollback

**Effort:** 2 hours

---

### PHASE 6: Build Payment Module

**Routes needed:**
```
POST /api/payments/init              â†’ Initialize payment (create session)
POST /api/webhooks/payment           â†’ Handle payment provider callback
GET  /api/payments/{order_id}        â†’ Get payment status
```

**Create:**
- `internal/payment/model.go`
- `internal/payment/repository.go`
- `internal/payment/service.go` (handles payment provider integration!)
- `internal/payment/handler.go`
- `internal/payment/routes.go`

**Payment Flow:**
```
1. User clicks "Pay" after placing order
2. POST /api/payments/init with order_id
3. Service calls payment provider (Stripe, PayPal, etc.)
4. Returns payment session URL
5. User completes payment on provider's page
6. Provider calls POST /api/webhooks/payment with confirmation
7. Webhook handler verifies signature + updates order status
8. Order marked as "paid"
```

**Effort:** 2 hours (without actual provider integration)

---

### PHASE 7: Testing & Validation

**Manual Testing (Postman):**
```
1. Register user
2. Get JWT token
3. List restaurants
4. Get restaurant menu
5. Add items to cart
6. View cart
7. Create order â†’ should return order_id
8. Check pgAdmin: verify rows in orders + order_items
9. Create order with same idempotency_key â†’ should return same order (no duplicate)
10. Get order details with items
11. Initialize payment
12. Trigger webhook (manual POST)
13. Verify order status changed to "paid"
```

**Database Checks:**
- Orders inserted correctly
- Foreign keys intact
- Idempotency prevents duplicates
- Transactions rollback on error

**Effort:** 1 hour

---

### PHASE 8: Production Hardening

**Add:**
- [ ] Request validation middleware (check required fields)
- [ ] Structured error responses (error codes + messages)
- [ ] Structured logging (JSON logs with request IDs)
- [ ] Request/response logging middleware
- [ ] Rate limiting on auth endpoints
- [ ] CORS headers
- [ ] Request timeout handling
- [ ] Panic recovery middleware
- [ ] Database connection pooling optimization
- [ ] Database query timeout context

**Effort:** 2 hours

---

## ğŸ“‹ Immediate Action Items (Next 2 Hours)

### 1. Add Missing SQLC Queries (30 min)
Edit `internal/db/queries/queries.sql`:
- Add GetAllRestaurants
- Add GetRestaurantByID
- Add GetMenuItemsByRestaurantID
- Add Cart queries
- Add Order list queries

Then: `sqlc generate`

### 2. Refactor to pgxpool + SQLC (45 min)
Update main.go to:
```go
pool, _ := pgxpool.New(ctx, dbURL)
queries := db.New(pool)
// pass queries to handlers
```

### 3. Build Restaurant Module (1 hour)
Create 5 files in `internal/restaurant/`:
- model.go
- repository.go
- service.go
- handler.go
- routes.go

### 4. Test Everything
```bash
go build ./cmd/server
curl tests in Postman
```

---

## ğŸ¯ Complete Build Timeline

| Phase | Modules | Effort | Status |
|-------|---------|--------|--------|
| 1 | Database Setup | 2 hours | âœ… DONE |
| 2A | SQLC Queries | 0.5 hours | â³ NEXT |
| 2B | DB Connection Refactor | 0.75 hours | â³ NEXT |
| 3 | Restaurant | 1 hour | â³ NEXT |
| 4 | Cart | 1.5 hours | TODO |
| 5 | Order (COMPLEX) | 2 hours | TODO |
| 6 | Payment | 2 hours | TODO |
| 7 | Testing | 1 hour | TODO |
| 8 | Production Ready | 2 hours | TODO |
| **TOTAL** | | **12.75 hours** | - |

---

## ğŸ”§ Technical Debt / Important Notes

### Current Issues:
1. **User module uses raw SQL** instead of SQLC â†’ needs refactor
2. **No request validation** â†’ will accept bad data
3. **No error codes** â†’ hard to debug API issues
4. **No logging** â†’ can't trace problems in production
5. **No transaction handling** in order creation â†’ data consistency risk
6. **No payment provider integration** â†’ need to pick one (Stripe/PayPal)

### Best Practices Applied:
- âœ… Clean architecture (handler â†’ service â†’ repository)
- âœ… JWT authentication with middleware
- âœ… SQLC for type-safe queries
- âœ… Database migrations
- âœ… Idempotency keys (prevents duplicate orders)
- âœ… Foreign key constraints
- âœ… Proper indexes

### Still Need:
- âŒ Transaction management
- âŒ Request validation
- âŒ Structured logging
- âŒ Error codes
- âŒ Rate limiting
- âŒ CORS headers
- âŒ Payment provider integration
- âŒ Comprehensive tests

---

## ğŸš€ Next Command to Run

```bash
cd /Users/danemmanuel/Desktop/SwiftEats/backend/swiftEats-backend
# Add missing queries to internal/db/queries/queries.sql
# Then:
sqlc generate
go build ./cmd/server
```
